

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>7. Modificación y escritura de datos &#8212; gvsig 0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../../../_static/gvSIG.ico"/>
    <link rel="top" title="gvsig 0 documentation" href="../../../../index.html" />
    <link rel="up" title="Acceso a datos tabulares" href="../acceso_a_datos_tabulares.html" />
    <link rel="next" title="8. La pila de comandos de edición" href="api_pila_comandos_edicion.html" />
    <link rel="prev" title="6. Modificación de la estructura de un almacén" href="api_modificacion_de_la_estructura_de_un_almacen.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api_pila_comandos_edicion.html" title="8. La pila de comandos de edición"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api_modificacion_de_la_estructura_de_un_almacen.html" title="6. Modificación de la estructura de un almacén"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">gvSIG Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Documentación de gvSIG (ES)</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../acceso_a_datos_tabulares.html" accesskey="U">Acceso a datos tabulares</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/gvsig_asoc.jpg" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="api_modificacion_de_la_estructura_de_un_almacen.html"
                        title="previous chapter">6. Modificación de la estructura de un almacén</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api_pila_comandos_edicion.html"
                        title="next chapter">8. La pila de comandos de edición</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/es/org.gvsig.fmap.dal/2.2/acceso_a_datos_tabulares/api_modificacion_y_escritura_de_datos.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <gcse:search></gcse:search>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script>
  (function() {
    var cx = '000928295531310476676:vy4vt1ahxhe';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="modificacion-y-escritura-de-datos">
<h1>7. Modificación y escritura de datos<a class="headerlink" href="#modificacion-y-escritura-de-datos" title="Permalink to this headline">¶</a></h1>
<p>En este apartado veremos conceptos como:</p>
<ul class="simple">
<li>inserción de nuevos fenómenos en un almacén</li>
<li>modificación de fenómenos ya existentes en un almacén</li>
<li>eliminación de fenómenos de un almacén.</li>
<li>reglas de validación.</li>
</ul>
<p>El <em>almacén</em> dispone de servicios que nos permiten
la modificación de los datos. Para poder modificar los
datos, lo primero que deberemos hacer es notificar al
<em>almacén</em> que vamos a modificar datos suyos. Y, al
igual que le notificamos que queremos modificarlos,
tendremos que informarle cuando hayamos terminado
de hacerlo. Una vez informamos al almacén que vamos a
modificar los datos, este entra en modo <em>modificación
de datos</em>, y permanecerá en ese modo hasta que le
digamos que hemos terminado.</p>
<p>Antes de seguir adelante vamos ha hacer un inciso sobre
el modo de operación en el que se puede encontrar un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureStore.html">FeatureStore</a> .
Estos puede ser:</p>
<ul class="simple">
<li>Modo consulta, <em>MODE_QUERY</em>. Es el modo por defecto
para un <em>almacén</em>. Cuando es creado uno se queda en
este modo. En este modo solo se pueden realizar operaciones
de consulta, no están permitidas la ejecución de operaciones
de edición. En caso de intentar ejecutar alguna se producirá
una excepción <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/exception/NeedEditingModeException.html">NeedEditingModeException</a> .</li>
<li>Modo edición, <em>MODE_FULLEDIT</em>. En este modo se permiten
todos los comandos de edición. Se dispondrá de servicios
de hacer/rehacer operaciones y las operaciones de edición
no se consolidaran hasta que se termine la edición.</li>
<li>Modo añadir, <em>MODE_APPEND</em>. Es un modo de edición limitado.
No están habilitados los servicios de hacer/rehacer, y las
únicas acciones relacionadas con edición que están permitidas
son las de <em>insert</em> de un nuevo fenómeno y <em>finishEditing</em>.
La consolidación de los cambios queda a criterio del proveedor
de datos final si se realiza cada vez que se ejecute la
acción <em>insert</em> o al ejecutarse la acción <em>finishediting</em>.
No todos los proveedores de datos soportan este modo. En
caso de que el proveedor no lo soporte y sea solicitado,
el <em>almacén</em> entrara automáticamente en modo <em>edición</em>.</li>
</ul>
<p>Hay que destacar que el <em>Modo edición</em> está disponible para <em>todos</em> los
almacenes. Ahora bien, es posible de que el <em>almacén</em> no tenga
permitida la persistencia de los datos (ver método <em>allowWrite</em>) por
lo que, al finalizar la edición podemos obtener una excepción dependiendo
si podemos escribir en el <em>almacén</em> o si hemos realizado o no cambios <em>mayores</em>.</p>
<p>Ahora veamos cuales son las acciones, relacionadas con
edición que nos permite realizar el <em>almacén</em> de fenómenos:</p>
<ul class="simple">
<li><em>allowWrite</em>. Esta acción nos informa si el <em>almacén</em>
en cuestión es susceptible de escribir las modificaciones
sobre el soporte de almacenamiento que tenga asociado.</li>
<li><em>edit</em>. Esta acción es con la que le indicamos
al almacén que queremos entrar en modo <em>modificación
de datos</em>. Esta acción sin ningún otro parámetro mas
entrara en modo <em>edición</em>, de otra forma habrá que indicar como
parámetro en que modo de edición se quiere entrar.</li>
<li><em>cancelEditing</em>. Esta acción nos permite indicarle al
<em>almacén</em> que queremos cancelar todas las modificaciones
y pasar a modo normal o de consulta.</li>
<li><em>finishEditing</em>. Con esta acción le indicamos al almacén
que de por terminadas las acciones de modificación, consolide
los cambios y salga del modo de <em>modificación de datos</em>.</li>
<li><em>isEditing</em>. Nos informa si el almacén se
encuentra en modo <em>modificación de datos</em> o
no.</li>
<li><em>isAppending</em>. Nos informa si el almacén se
encuentra en modo <em>adición de datos</em> o
no.</li>
<li><em>undo</em>. Una vez estamos en modo <em>modificación de datos</em>
y ya hemos realizado algunas modificaciones sobre el
<em>almacén</em>, esta acción nos permite ir <em>deshaciendo</em> una
a una las modificaciones realizadas.</li>
<li><em>redo</em>. Cuando hemos invocado al método <em>undo</em>, podemos
volver a indicarle al <em>almacén</em> que de por valida la ultima
acción cancelada mediante la acción <em>undo</em> invocando a
este método. Podremos ir rehaciendo todas las acciones
canceladas con el método <em>undo</em> invocando sucesivamente al
método <em>redo</em></li>
<li><em>insert</em>. Inserta un fenómeno en el almacén.</li>
<li><em>update</em>. Actualizar un fenómeno del almacén.</li>
<li><em>delete</em>. Elimina un fenómeno del almacén.</li>
<li><em>createNewFeature</em>. Al invocar a este método con un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/FeatureType.html">FeatureType</a> ,
el <em>almacén</em> creara un nuevo fenómeno con la estructura
indicada en el <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/FeatureType.html">FeatureType</a> pasado. Además podemos indicar
si queremos o no que se el nuevo fenómeno se rellene con los
valores por defecto para ese tipo.</li>
<li><em>isAppendModeSupported</em>, nos informa si el <em>almacén</em>
soporta el modo de edición <em>añadir nuevos fenómenos</em>.
Este modo de edición presenta solo un subconjunto de las
funciones de edición del <em>almacén</em> y esta orientado a la
creación en modo no interactivo de nuevos juegos de datos.</li>
<li><em>beginEditingGroup</em>, <em>endEditingGroup</em>, que permiten
agrupar un conjunto de instrucciones de edición como si
de una sola se tratase a efectos de las acciones hacer/rehacer.</li>
</ul>
<p>Además de las acciones del <em>almacén</em> que nos permiten realizar
modificaciones en los datos, conviene repasar cuales son las
acciones de los fenómenos que nos van a permitir modificar sus
datos. En principio, un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/Feature.html">Feature</a> es de solo <em>lectura</em>, es decir,
solo podemos realizar operaciones de consulta sobre el. Si queremos
modificar un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/Feature.html">Feature</a> tendremos que obtener un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/">EditableFeature</a> a
partir de el, el cual ya tendrá acciones asociadas a modificar sus
datos. Para obtener un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/EditableFeature.html">EditableFeature</a> usaremos el método <em>getEditable</em>
del <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/Feature.html">Feature</a> . El método <em>createNewFeature</em> ya devuelve un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/EditableFeature.html">EditableFeature</a> .
El <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/EditableFeature.html">EditableFeature</a> se comporta como un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/Feature.html">Feature</a> añadiéndole
una serie de acciones mas. Las mas importantes serian:</p>
<ul class="simple">
<li><em>set</em> para permitirnos modificar los valores de los
atributos.</li>
<li><em>setString, setInt, setGeometry</em> para permitirnos modificar los valores de los
atributos usando tipos específicos.</li>
<li><em>getNotEditableCopy</em>, que nos devolverá una copia no modificable
del <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/EditableFeature.html">EditableFeature</a> .</li>
</ul>
<p>Veamos ahora un ejemplo simple de como usar estas acciones para
insertar un nuevo fenómeno dentro el almacén. Vamos a suponer que
disponemos de un archivo <em>dbf</em> que contiene dos campos, un campo
<em>NOMBRE</em> y otro <em>TIPO</em> de tipo cadena. La apertura del almacén
se realiza tal como hemos hecho para acceder en modo lectura.
Una vez tenemos una instancia de <em>almacén</em>, el código para
añadir un nuevo fenómeno seria:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">createStore</span><span class="o">(</span><span class="n">parameters</span><span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>

<span class="n">EditableFeature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">createNewFeature</span><span class="o">();</span>
<span class="n">feature</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;NOMBRE&quot;</span><span class="o">,</span> <span class="s">&quot;Burjasot&quot;</span><span class="o">);</span>
<span class="n">feature</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;TIPO&quot;</span><span class="o">,</span> <span class="s">&quot;MUNICIPIO&quot;</span><span class="o">);</span>

<span class="n">store</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">feature</span><span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">finishEditing</span><span class="o">();</span>

<span class="n">store</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
</pre></div>
</div>
<p>Los pasos serian los siguientes:</p>
<ul class="simple">
<li>comunicar al <em>almacén</em> que  vamos a entrar en
modo <em>modificación de datos</em>.</li>
<li>Pedirle al almacén que nos suministre un fenómeno
vació de contenido y con la estructura de los
fenómenos del almacén.</li>
<li>Asignamos los nuevos valores a los atributos.</li>
<li>Insertamos en el almacén la nueva feature.</li>
<li>Y por ultimo le comunicamos al almacén que
hemos terminado de hacer modificaciones sobre el.</li>
</ul>
<p>Tenemos que tener en cuenta que asta que no se ejecute la
acción <em>finishEditing</em> sobre el almacén, los cambios
que se hayan realizados no serán visibles para otros
usuarios o aplicaciones que estén accediendo al mismo
<em>almacén</em>.</p>
<p>Una cuestión importante a tener en cuenta relacionada con la
actualización o borrado de datos de un almacén es que pasa con
los conjuntos de datos que se han obtenido de ese almacén y sobre
los que se puede estar trabajando desde otros puntos de la aplicación.
En principio el almacén invalida todos los <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a> que
se han obtenido de el tras una operación de modificación o
borrado en el almacén. De forma que tras esta operación cualquier
intento de acceder a un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a> obtenido con anterioridad producirá
una excepción de tiempo de ejecución <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/">ConcurrentModificationException</a> .
Para evitar que mientras estemos recorriendo un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a> y realizando
actualización o borrados en él este quede invalidado, usaremos los
métodos <em>delete</em>, <em>insert</em> y <em>update</em> de <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a> o el método <em>remove</em>
del <em>iterador</em> asociado al <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a>.</p>
<p>Veamos como podríamos hacer para modificar los fenómenos
de nuestro  almacén en <em>dbf</em>. Supongamos que queremos
cambiar el valor del atributo <em>TIPO</em> para el fenómeno
que tiene en el atributo <em>NOMBRE</em> el valor &#8220;Burjasot&#8221;.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">store</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>

<span class="n">EditableFeature</span> <span class="n">feature</span><span class="o">;</span>
<span class="n">FeatureQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">createFeatureQuery</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span> <span class="n">manager</span><span class="o">.</span><span class="na">createExpresion</span><span class="o">(</span><span class="s">&quot;NOMBRE = &#39;Burjasot&#39;&quot;</span><span class="o">)</span> <span class="o">);</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureSet</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>

<span class="n">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
<span class="k">while</span><span class="o">(</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
  <span class="n">feature</span> <span class="o">=</span> <span class="o">((</span><span class="n">Feature</span><span class="o">)</span><span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()).</span><span class="na">getEditable</span><span class="o">();</span>
  <span class="n">feature</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;TIPO&quot;</span><span class="o">,</span> <span class="s">&quot;Municipio&quot;</span><span class="o">);</span>
  <span class="n">features</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">feature</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">features</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>

<span class="n">store</span><span class="o">.</span><span class="na">finishEditing</span><span class="o">();</span>

<span class="n">store</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
</pre></div>
</div>
<ul class="simple">
<li>Filtramos sobre el <em>almacén</em> para obtener solo los fenómenos
que queremos.</li>
<li>Informamos al almacén que queremos realizar modificaciones sobre
el.</li>
<li>para cada fenómeno recuperado, le pedimos un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/EditableFeature.html">EditableFeature</a> ,
y lo modificamos.</li>
<li>después pedimos al <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureSet.html">FeatureSet</a> que actualice el fenómeno
en el <em>almacén</em></li>
<li>Y por ultimo le decimos al <em>almacén</em> que hemos terminado
de realizar modificaciones.</li>
</ul>
<p>Si quisiésemos eliminar los fenómenos que tienen como <em>NOMBRE</em>
el valor &#8220;Burjasot&#8221; seria similar a la actualización pero
invocando al método <em>delete</em> en lugar de <em>update</em>:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">store</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>

<span class="n">FeatureQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">createFeatureQuery</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span> <span class="n">manager</span><span class="o">.</span><span class="na">createExpresion</span><span class="o">(</span><span class="s">&quot;NOMBRE = &#39;Burjasot&#39;&quot;</span><span class="o">)</span> <span class="o">);</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getFeatureSet</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>

<span class="n">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
<span class="k">while</span><span class="o">(</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
  <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
  <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
<span class="o">}</span>
<span class="n">features</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>

<span class="n">store</span><span class="o">.</span><span class="na">finishEditing</span><span class="o">();</span>
<span class="n">store</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
</pre></div>
</div>
<p>Relacionado con la modificación e inserción de fenómenos en un
<em>almacén de datos</em>, esta la posibilidad de asignar reglas de validación
a los fenómenos de un <em>almacén</em>. Las reglas de validación se asignan
a cada tipo de fenómeno del almacén, es decir es el <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/FeatureType.html">FeatureType</a>
el que controla que reglas hay que aplicar a los fenómenos de su tipo.</p>
<p>Podemos invocar manualmente a las reglas de validación sobre un fenómeno
mediante la acción <em>validate</em> de <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/Feature.html">Feature</a> o sobre todos fenómenos del
<em>almacén</em> mediante la acción <em>validateFeatures</em> del <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureStore.html">FeatureStore</a> .</p>
<p>A la hora de crear una regla de validación tendremos que tener en cuenta que
una regla de validación puede ejecutarse...</p>
<ul class="simple">
<li>Cuando se inserte o actualice un fenómeno en el <em>almacén de datos</em></li>
<li>Al finalizar la edición se ejecutan las reglas de validación de
todas los fenómenos del <em>almacén</em>.</li>
<li>En ambos casos.</li>
</ul>
<p>Según nos interese tendremos que indicar cuando queremos que se ejecute
la regla de validación.</p>
<p>Vamos a crear una regla de validación que se encarga de que
el sentido de los segmentos de los polígonos sea el adecuado.</p>
<p>Para ello deberemos crear una clase que implemente el interface <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureRule.html">FeatureRule</a> .
Este interface nos obliga a suministrar los siguientes métodos:</p>
<ul class="simple">
<li><em>getName</em>, con el nombre que le queramos dar a la regla de
validación.</li>
<li><em>getDescription</em>, opcionalmente podemos incluir una descripción de
unas lineas asociada a la regla de validación.</li>
<li><em>checkAtUpdate</em>, devolverá el valor de cierto si la regla debe ser
ejecutada en el momento de realizarse una modificación o inserción de un
nuevo fenómeno.</li>
<li><em>checkAtFinishEdition</em>, devolverá el valor cierto si la regla debe
ejecutarse sobre todos los fenómenos del almacén al finalizar la
edición.</li>
<li><em>validate</em>, que ejecutara la validación sobre el fenómeno que reciba
como parámetro. En caso de que no pase la regla de validación lanzara
una excepción.</li>
</ul>
<p>Además de este interface, existe una clase abstract <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/AbstractFeatureRule.html">AbstractFeatureRule</a>
que nos resuelve la gestión de cuando ha de ejecutarse, el nombre y la descripción
de la regla, dejando únicamente pendiente le implementación del método
<em>validate</em>.</p>
<blockquote>
<div><p>FIXME:</p>
<p>El ejemplo siguiente esta asumiendo que el validate solo
va a ser llamado estando en modo edición. Habría que comprobar
esto antes de invocar al <em>update</em> del store.</p>
</div></blockquote>
<p>Veamos como quedaría nuestro ejemplo:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeatureRulePolygon</span> <span class="kd">extends</span> <span class="n">AbstractFeatureRule</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nf">FeatureRulePolygon</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="s">&quot;RulePolygon&quot;</span><span class="o">,</span> <span class="s">&quot;Ensure orientation of geometry&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Feature</span> <span class="n">feature</span><span class="o">,</span> <span class="n">FeatureStore</span> <span class="n">store</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">DataException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">Geometry</span> <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="na">getDefaultGeometry</span><span class="o">();</span>
      <span class="n">GeneralPathX</span> <span class="n">gp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GeneralPathX</span><span class="o">();</span>
      <span class="n">gp</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">geom</span><span class="o">.</span><span class="na">getPathIterator</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">Converter</span><span class="o">.</span><span class="na">FLATNESS</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">gp</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">gp</span><span class="o">.</span><span class="na">isCCW</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">gp</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
          <span class="n">GeometryFactory</span> <span class="n">geomFactory</span> <span class="o">=</span> <span class="n">GeometryManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>
              <span class="o">.</span><span class="na">getGeometryFactory</span><span class="o">();</span>
          <span class="n">geom</span> <span class="o">=</span> <span class="n">geomFactory</span><span class="o">.</span><span class="na">createPolygon2D</span><span class="o">(</span><span class="n">gp</span><span class="o">);</span>
          <span class="n">EditableFeature</span> <span class="n">editable</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="na">getEditable</span><span class="o">();</span>
          <span class="n">editable</span><span class="o">.</span><span class="na">setDefaultGeometry</span><span class="o">(</span><span class="n">geom</span><span class="o">);</span>
          <span class="n">store</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">editable</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">FeatureRulePolygonException</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">store</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeatureRulePolygonException</span> <span class="kd">extends</span> <span class="n">DataException</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3014970171661713021L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">MESSAGE_FORMAT</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t apply rule  in store %(store)s.&quot;</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">MESSAGE_KEY</span> <span class="o">=</span> <span class="s">&quot;_FeatureRulePolygonException&quot;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">FeatureRulePolygonException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">,</span> <span class="n">String</span> <span class="n">store</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">MESSAGE_FORMAT</span><span class="o">,</span> <span class="n">cause</span><span class="o">,</span> <span class="n">MESSAGE_KEY</span><span class="o">,</span> <span class="n">serialVersionUID</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">&quot;store&quot;</span><span class="o">,</span> <span class="n">store</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<p>Podemos observar que el método <em>validate</em> recibe la feature a validar
y el <em>almacén</em> donde esta vive, y se limita a coger la geometría
de la feature, procesarla y si es preciso actualizar el feature con
los nuevos valores.</p>
<p>Durante la validación de una regla podremos actualizar el fenómeno que
estamos tratando, pero no deberemos cambiar la estructura del almacén, es
decir, no deberemos realizar ninguna operación que modifique los <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/gazetteer/querys/FeatureType.html">FeatureType</a>
de este.</p>
<p>Si durante el proceso de validación de fenómenos que se realiza al
finalizar la edición alguien modifica algún fenómeno, se abortara el
proceso, quedando a decisión del que invoco a <em>finishEdition</em> comprobar
si fue por una modificación de los fenómenos mientras se procesaban para
volver a lanzar la operación.</p>
<blockquote>
<div><p>Nota:</p>
<p>Aquí habría que poner un ejemplo de como hacer esto.</p>
</div></blockquote>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="api_pila_comandos_edicion.html" title="8. La pila de comandos de edición"
             >next</a> |</li>
        <li class="right" >
          <a href="api_modificacion_de_la_estructura_de_un_almacen.html" title="6. Modificación de la estructura de un almacén"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">gvSIG Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Documentación de gvSIG (ES)</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../acceso_a_datos_tabulares.html" >Acceso a datos tabulares</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, gvSIG Association.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>