

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>11. Soporte para atributos calculados &#8212; gvsig 0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/bizstyle.js"></script>
    <link rel="shortcut icon" href="../../../../_static/gvSIG.ico"/>
    <link rel="top" title="gvsig 0 documentation" href="../../../../index.html" />
    <link rel="up" title="Acceso a datos tabulares" href="../acceso_a_datos_tabulares.html" />
    <link rel="next" title="12. Transformaciones sobre almacenes" href="api_transformacion_sobre_almacenes.html" />
    <link rel="prev" title="10. Soporte de índices" href="api_soporte_indices.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api_transformacion_sobre_almacenes.html" title="12. Transformaciones sobre almacenes"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api_soporte_indices.html" title="10. Soporte de índices"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">gvSIG Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Documentación de gvSIG (ES)</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../acceso_a_datos_tabulares.html" accesskey="U">Acceso a datos tabulares</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/gvsig_asoc.jpg" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="api_soporte_indices.html"
                        title="previous chapter">10. Soporte de índices</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api_transformacion_sobre_almacenes.html"
                        title="next chapter">12. Transformaciones sobre almacenes</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/es/org.gvsig.fmap.dal/2.2/acceso_a_datos_tabulares/api_soporte_para_atributos_calculados.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <gcse:search></gcse:search>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script>
  (function() {
    var cx = '000928295531310476676:vy4vt1ahxhe';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="soporte-para-atributos-calculados">
<h1>11. Soporte para atributos calculados<a class="headerlink" href="#soporte-para-atributos-calculados" title="Permalink to this headline">¶</a></h1>
<p>En este apartado veremos:</p>
<ul class="simple">
<li>Como añadir un atributo calculado simple, basado
en una expresión de cadena.</li>
<li>Algunas consideraciones sobre la edición y los
atributos calculados.</li>
<li>Como crear un campo calculado complejo que requiera
un evaluador especializado.</li>
</ul>
<p>En el apartado <a class="reference external" href="api_creacion_de_un_nuevo_almacen.html">creación de un nuevo almacén</a> vimos como crear un
alamcén en formato <em>dbf</em> en el que teníamos un atributo <em>POBLACION</em> y
otro <em>AREA</em>.</p>
<p>Puede ser interesante disponer del valor de densidad de población en
ese mismo almacén. En lugar de añadirle un nuevo atributo con el valor de
la densidad de población podemos añadirle un atributo que calcule la
densidad de población en función de los campos <em>AREA</em> y <em>POBLACION</em>.</p>
<p>Veamos como podríamos hacer esto.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">store</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>
<span class="n">FeatureType</span> <span class="n">featureType</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getDefaultFeatureType</span><span class="o">();</span>
<span class="n">EditableFeatureType</span> <span class="n">editableFeatureType</span> <span class="o">=</span> <span class="n">featureType</span><span class="o">.</span><span class="na">getEditable</span><span class="o">();</span>
<span class="n">editableFeatureType</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;DENSIDAD_POBLACION&quot;</span><span class="o">,</span>
        <span class="n">DataTypes</span><span class="o">.</span><span class="na">DOUBLE</span><span class="o">,</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">createExpresion</span><span class="o">(</span><span class="s">&quot;POBLACION / AREA&quot;</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">editableFeatureType</span><span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">finishEditing</span><span class="o">();</span>
</pre></div>
</div>
<p>Para añadir el nuevo atributo, deberemos añadir a la descripción del
fenómeno del almacén un nuevo atributo. Veamos una breve explicación
de los pasos que hemos seguido para realizar esta operación:</p>
<ol class="arabic simple">
<li>Puesto que vamos a realizar una modificación sobre
el almacén, deberemos asegurarnos que este se encuentra
en modo edición.</li>
<li>Invocaremos a <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureStore.html#getDefaultFeatureType()">getDefaultFeatureType</a> para obtener la descripción
de los fenómenos del almacén. Una vez dispongamos
de el, obtendremos una versión <em>editable</em> de este, ya que el que nos
devuelve <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureStore.html#getDefaultFeatureType()">getDefaultFeatureType</a> es de solo consulta.</li>
<li>Invocaremos a su método <em>add</em> para añadirle el nuevo atributo.
a este le indicaremos:<ul>
<li>El nombre del atributo a añadir, <em>DENSIDAD_POBLACION</em>.</li>
<li>El tipo de datos asociado al atributo, <em>TYPE_DOUBLE</em>.</li>
<li>Un evaluador que resuelva la expresión que deseamos.
El <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/DataManager.html">DataManager</a> nos suministrara un constructor por
defecto para evaluadores de expresiones mediante su método
<em>createExpresion</em>, asi que le diremos que la expresión que
deseamos que tenga sera &#8220;POBLACION / AREA&#8221;.</li>
</ul>
</li>
<li>invocaremos al método <em>update</em> del almacén, <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureStore.html">FeatureStore</a>,
con el <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/feature/FeatureType.html">FeatureType</a> modificado para que se apliquen los cambios.</li>
<li>Por ultimo, si hemos iniciado la edición para realizar esta
operación la terminaremos.</li>
</ol>
<p>Hay que tener en cuenta una consideración respecto a la adición de
campos calculados a un almacén. Para realizar esta operación es preciso
entrar en edición del almacén y finalizarla al terminar de añadir
los campos calculados. Sin embargo, la operación de inserción de
campos calculados no afecta a los datos del almacén ni a la
estructura de este. Es decir, al finalizar al edición no se realiza
ninguna modificación sobre el almacén físico de datos. Los cambios
quedan únicamente en la definición en memoria de este. Se trata de
una edición que provoca unos cambios <em>ligeros</em> o <em>suaves</em> por decirlo
de alguna manera. Cuando la edición provoca cambios de este tipo, no
precisa que el almacén soporte escritura. Es decir podemos hacer este
tipo de operaciones de edición sobre almacenes aunque la invocación a
<em>allowWrite</em> sobre el almacén indique que no esta soportada la escritura.</p>
<p>Veamos ahora un ejemplo algo mas complejo de atributo calculado.
En el ejemplo anterior utilizábamos el evaluador de expresiones que
suministra por defecto el <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/DataManager.html">DataManager</a>. Ahora bien, puede suceder que
este evaluador de expresiones no nos de la capacidad de calculo que
necesitemos para nuestro atributo. En estos casos podemos crear
nuestro propio evaluador a medida de las operaciones que deseemos.
Veamos esto con un ejemplo.</p>
<p>Supongamos que tenemos un fichero <em>dbf</em> en el que tenemos dos atributos,
<em>X</em> e <em>Y</em> con las coordenadas x e y de un punto, y quisiésemos representar
esos puntos como tales en lugar de como dos simples números. Podríamos
añadir un atributo calculado que nos devolviese una geometría construida
a partir de los valores de los campos <em>X</em> e <em>Y</em>. Veamos el ejemplo, por
un lado necesitaremos crear nuestro evaluador:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">XY2Geometry</span> <span class="kd">extends</span> <span class="n">AbstractEvaluator</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">xname</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">String</span> <span class="n">yname</span><span class="o">;</span>
     <span class="kd">private</span> <span class="n">GeometryManager</span> <span class="n">geomManager</span><span class="o">;</span>

     <span class="kd">public</span> <span class="n">XY2Geometry</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">String</span> <span class="n">xname</span><span class="o">,</span> <span class="n">String</span> <span class="n">yname</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">xname</span> <span class="o">=</span> <span class="n">xname</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">yname</span> <span class="o">=</span> <span class="n">yname</span><span class="o">;</span>
        <span class="n">geomManager</span> <span class="o">=</span> <span class="n">GeometryLocator</span><span class="o">.</span><span class="na">getGeometryManager</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">EvaluatorData</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">EvaluatorException</span> <span class="o">{</span>
        <span class="n">Double</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">Double</span><span class="o">)</span> <span class="n">data</span><span class="o">.</span><span class="na">getDataValue</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">xname</span><span class="o">);</span>
        <span class="n">Double</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="n">Double</span><span class="o">)</span> <span class="n">data</span><span class="o">.</span><span class="na">getDataValue</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">yname</span><span class="o">);</span>
        <span class="n">Geometry</span> <span class="n">geom</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">geomManager</span><span class="o">.</span><span class="na">createPoint</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">doubleValue</span><span class="o">(),</span> <span class="n">y</span>
                <span class="o">.</span><span class="na">doubleValue</span><span class="o">(),</span> <span class="n">Geometry</span><span class="o">.</span><span class="na">SUBTYPES</span><span class="o">.</span><span class="na">GEOM2D</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CreateGeometryException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">EvaluatorException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">geom</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;XY2Geometry&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>La clase abstracta <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/tools/evaluator/AbstractEvaluator.html">AbstractEvaluator</a>, nos deja dos métodos por implementar:</p>
<ul class="simple">
<li><em>getName</em>, que deberá devolver un nombre descriptivo de la operación
que vallamos a hacer.</li>
<li><em>evaluate</em>, que recibe un <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/tools/evaluator/Evaluator.html">EvaluatorData</a>, en el que recibiremos los
valores del resto de atributos del fenómeno. Este método deberá ser
el encargado de realizar los cálculos y devolver el resultado de estos.
En nuestro caso, obtendrá los valores de los campos x e y, y con ellos
construirá una geometría de tipo punto que sera lo que devuelva.</li>
</ul>
<p>Además de estos métodos, le hemos añadido un método <em>initialize</em> en el
que le pasamos los parámetros que necesita para realizar correctamente los
cálculos. Es recomendable disponer de un método de inicialización separado
del constructor ya que eso nos puede facilitar las tareas de serialización
del objeto en caso de que lo necesitemos.</p>
<p>Y una vez dispongamos de un evaluador adecuado podemos añadir ya
nuestro atributo calculado al almacén:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">store</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>
<span class="n">FeatureType</span> <span class="n">featureType</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">getDefaultFeatureType</span><span class="o">();</span>
<span class="n">EditableFeatureType</span> <span class="n">editableFeatureType</span> <span class="o">=</span> <span class="n">featureType</span><span class="o">.</span><span class="na">getEditable</span><span class="o">();</span>
<span class="n">editableFeatureType</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;GEOM&quot;</span><span class="o">,</span>
  <span class="n">DataTypes</span><span class="o">.</span><span class="na">GEOMETRY</span><span class="o">,</span>
  <span class="k">new</span> <span class="n">XY2Geometry</span><span class="o">().</span><span class="na">initialize</span><span class="o">(</span><span class="s">&quot;X&quot;</span><span class="o">,</span> <span class="s">&quot;Y&quot;</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">editableFeatureType</span><span class="o">);</span>
<span class="n">store</span><span class="o">.</span><span class="na">finishEditing</span><span class="o">();</span>
</pre></div>
</div>
<p>En este caso, a diferencia de nuestro ejemplo anterior sobre la densidad
de población, en la invocación al método <em>add</em>, le indicaremos:</p>
<ul class="simple">
<li>El nombre del nuevo atributo que añadimos, <em>GEOM</em>.</li>
<li>Que su tipo de datos, en lugar de ser <em>DOUBLE</em>, ahora es
un <em>GEOMETRY</em>.</li>
<li>Y que en lugar de invocar al <a class="reference external" href="http://downloads.gvsig.org/download/gvsig-desktop-testing/dists/2.3.0/javadocs/html/org/gvsig/fmap/dal/DataManager.html">DataManager</a> para obtener un
evaluador de expresiones de cadena, construimos una instancia
de nuestro evaluador, <em>XY2Geoemtry</em>, la inicializamos con los
valores de los nombres de los campos que contienen la x e y, y
se la pasamos como el evaluador a usar en ese campo.</li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="api_transformacion_sobre_almacenes.html" title="12. Transformaciones sobre almacenes"
             >next</a> |</li>
        <li class="right" >
          <a href="api_soporte_indices.html" title="10. Soporte de índices"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">gvSIG Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Documentación de gvSIG (ES)</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../acceso_a_datos_tabulares.html" >Acceso a datos tabulares</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, gvSIG Association.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>